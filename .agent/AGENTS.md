# Agent Rules: mcp-backpressure

> Generated by Agent Boilerplate Framework v0.1.0

## Prime Directive

You are implementing **mcp-backpressure** — Backpressure/concurrency control middleware for FastMCP MCP servers.

**CRITICAL RULES:**
1. Read PLAN.md before writing any code
2. Follow TDD: write tests FIRST, then implementation
3. Update STATE.md after completing each task
4. Run validation before marking complete

---

## Context Management (CRITICAL)

Claude CLI has limited context window (~200k tokens). You MUST manage it carefully.

### Monitor Context Usage
- **Estimate:** ~6% context per 100 LOC written + conversation overhead
- **This project:** ~55% estimated total
- **Checkpoint threshold:** 60%

### Every 3-4 Files — Check Yourself
Ask: "Have I used ~50-60% of context?" Signs:
- Written 500+ lines of code
- Long back-and-forth conversation
- Multiple debugging cycles

### At 50-60% Context — MANDATORY CHECKPOINT

**STOP** and execute this procedure:

1. **UPDATE STATE.md** with exact progress:
   ```markdown
   ## Current Session Progress
   - [x] Completed tasks
   - [ ] **IN PROGRESS:** Current task (X% done)
   - [ ] Remaining tasks
   
   ## Checkpoint Notes
   - Files created: list them
   - Decisions made: important choices
   - Blockers: any issues
   ```

2. **COMMIT** all changes:
   ```bash
   git add -A && git commit -m "checkpoint: [description]"
   ```

3. **OUTPUT** this exact message:
   ```
   ⚠️ CHECKPOINT REACHED
   
   Context usage: ~60%
   Progress: X/Y tasks complete
   
   To continue:
   1. Start new Claude session
   2. Use RESUME_PROMPT.md
   3. State will be restored from STATE.md
   ```

4. **STOP COMPLETELY** — do not write more code

### Why Checkpoints Matter
- Exceeding context → degraded responses, lost work
- STATE.md → memory between sessions
- Git commits → safe restore points

---

## Project Scope

Global concurrency limit (max_concurrent), bounded queue (queue_size), 
queue timeout, structured overload error (JSON-RPC -32001).
NO per-client limits, NO fairness, NO prometheus.


---

## Architecture

### Modules

- **core**: Main middleware, limiter, errors, metrics, types (~550 LOC)

- **tests**: Unit tests for concurrency, queue, timeout, cancellation (~750 LOC)

- **examples**: Simple server and load simulation examples (~180 LOC)

- **docs**: README, DESIGN.md, CHANGELOG (~250 LOC)

- **packaging**: pyproject.toml, CI workflow, py.typed (~150 LOC)


### Dependencies
Runtime:

- fastmcp>=2.9.0


Dev:

- pytest>=8.0

- pytest-asyncio>=0.23

- ruff>=0.4

- mypy>=1.10

- pytest-cov>=5.0


---

## Validation Requirements

Before marking project complete:

1. **Tests:** `pytest tests/ -v` — all pass
2. **Lint:** `ruff check src/ tests/` — no errors
3. **Manual test:** Run CLI with real input

4. **Codex review:** Basic code review


5. **Gemini review:** `./scripts/gemini_review.sh basic .`


### Bug Priority

| Priority | Criteria | Action |
|----------|----------|--------|
| P1 | Crashes, wrong results, security | Fix immediately |
| P2 | Edge cases, bad UX | Fix before v1.0 |
| P3 | Style, optimization | Backlog |

---

## Workflow

```
1. Read PLAN.md → understand tasks
2. For each task:
   a. Write test first
   b. Implement to pass test
   c. Check STATE.md checkbox
   d. Check context usage!
3. At 60% context → CHECKPOINT
4. Run full validation
5. Update AGENT_LOG.md
```

---

## File Locations

- Source: `src/mcp_backpressure/`
- Tests: `tests/`
- State: `.agent/STATE.md`
- Bugs: `BUGS.md`
